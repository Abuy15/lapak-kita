<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jual Barang - Lapak Banjarharjo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .content-wrapper { padding-bottom: 100px; }
    </style>
</head>
<body class="flex justify-center">

    <div class="w-full max-w-[480px] min-h-screen bg-white shadow-lg relative content-wrapper">
        <header class="bg-green-600 p-4 text-white sticky top-0 z-50 flex items-center gap-4 shadow-md">
            <a href="index.html"><i class="fas fa-arrow-left text-xl"></i></a>
            <h1 class="text-xl font-bold italic uppercase">Mulai Jualan</h1>
        </header>

        <form id="formJual" class="p-6 space-y-5">
            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-2xl border border-gray-100">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-600 font-bold">
                        <i class="fas fa-user text-sm"></i>
                    </div>
                    <span id="user-name" class="text-sm font-bold text-gray-700 italic">Memuat akun...</span>
                </div>
                <a href="profil.html" class="text-[10px] bg-white border px-3 py-1 rounded-full font-black text-green-600 uppercase">Profil</a>
            </div>

            <div class="space-y-2">
                <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest">Foto Produk</label>
                <div onclick="document.getElementById('inputFoto').click()" class="w-full h-52 border-2 border-dashed border-green-300 rounded-3xl bg-green-50 flex flex-col items-center justify-center cursor-pointer overflow-hidden relative">
                    <img id="previewImage" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="placeholderFoto" class="text-center">
                        <i class="fas fa-camera text-4xl text-green-400 mb-2"></i>
                        <p class="text-[10px] text-green-600 font-bold uppercase">Klik nggo milih foto</p>
                    </div>
                </div>
                <input type="file" id="inputFoto" accept="image/*" class="hidden">
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">Nama Barang</label>
                    <input type="text" id="nama_barang" required placeholder="Contoh: Mendoan Warmindo" class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-green-500 font-bold outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">Harga (Rp)</label>
                    <input type="number" id="harga_barang" required placeholder="5000" class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-green-500 font-bold outline-none">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest text-center">Desa</label>
                    <select id="desa" required class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none text-sm">
                        <option value="">Pilih--</option>
                        <option>Banjarharjo</option><option>Bandungsari</option><option>Malahayu</option>
                        <option>Cigadung</option><option>Pende</option><option>Sindangheula</option>
                        <option>Cikuya</option><option>Parereja</option><option>Kertasari</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest text-center">Kategori</label>
                    <select id="kategori" class="w-full p-4 bg-gray-50 border-none rounded-2xl font-bold outline-none text-sm">
                        <option>Kuliner</option><option>Tani</option><option>Fashion</option><option>Jasa</option><option>Lainnya</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">WhatsApp</label>
                <div class="relative">
                    <span class="absolute left-4 top-4 font-bold text-gray-400">+62</span>
                    <input type="number" id="wa" required placeholder="8123xxx" class="w-full p-4 pl-14 bg-gray-50 border-none rounded-2xl font-bold outline-none">
                </div>
            </div>

            <button type="submit" id="btnSubmit" class="w-full bg-green-600 text-white font-black py-5 rounded-3xl shadow-lg active:scale-95 transition-all text-sm uppercase italic tracking-widest">
                TAYANGKAN IKLAN
            </button>
        </form>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAowYbcfC9RsMCxKf2ZmwvTiLvooKaWI5U",
            databaseURL: "https://lapak-banjarharjo-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lapak-banjarharjo",
            authDomain: "lapak-banjarharjo.firebaseapp.com"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 1. CEK LOGIN
        auth.onAuthStateChanged(user => {
            const namaLocal = localStorage.getItem('user_nama');
            const waLocal = localStorage.getItem('user_wa');

            if (!user && !namaLocal) {
                window.location.href = "login.html";
            } else {
                document.getElementById('user-name').innerText = user ? user.displayName : namaLocal;
                if(waLocal) {
                    // Masukkan angka belakangnya saja ke input (buang 62 atau 0 di depan)
                    document.getElementById('wa').value = waLocal.replace(/^62|^0/, '');
                }
            }
        });

        // 2. FOTO HANDLER
        let base64Image = "";
        document.getElementById('inputFoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX = 600;
                    let w = img.width;
                    let h = img.height;
                    if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } }
                    else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('previewImage').src = base64Image;
                    document.getElementById('previewImage').classList.remove('hidden');
                    document.getElementById('placeholderFoto').classList.add('hidden');
                };
            };
            reader.readAsDataURL(file);
        });

        // 3. SUBMIT IKLAN
        document.getElementById('formJual').addEventListener('submit', function(e) {
            e.preventDefault();
            if(!base64Image) return alert("FotonÃ© dipasang dhisit!");
            
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerHTML = "SEDANG MENGIRIM...";

            // Bersihkan WA jadi 628...
            let rawWa = document.getElementById('wa').value.replace(/^0+|^62|^\+/, '');
            let waFinal = "62" + rawWa;

            db.ref('products').push({
                nama: document.getElementById('nama_barang').value,
                harga: document.getElementById('harga_barang').value,
                kategori: document.getElementById('kategori').value,
                desa: document.getElementById('desa').value,
                wa: waFinal,
                foto: base64Image,
                penjual: document.getElementById('user-name').innerText,
                timestamp: Date.now()
            }).then(() => {
                alert("MANTAP! Dagangan wis tayang.");
                window.location.href = "index.html";
            }).catch(err => {
                alert("Gagal: " + err.message);
                btn.disabled = false;
                btn.innerHTML = "TAYANGKAN IKLAN";
            });
        });
    </script>
</body>